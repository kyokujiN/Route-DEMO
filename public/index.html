<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Route Optimizer — demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; display:flex; height:100vh; }
    #left { width: 380px; padding: 12px; box-sizing:border-box; overflow:auto; border-right:1px solid #ddd; }
    #map { flex:1; }
    textarea { width:100%; height:160px; }
    button { padding:10px 14px; margin-top:8px; }
    .small { font-size: 13px; color:#555; }
    ol { padding-left: 18px; }
  </style>
</head>
<body>
  <div id="left">
    <h3>Route Optimizer — demo</h3>
    <p class="small">Wklej po jednym adresie w wierszu. (Dla testów używamy darmowego geokodera Nominatim.)</p>

    <label>Depo / start (opcjonalnie):</label><br/>
    <input id="depot" style="width:100%" placeholder="np. Rynek Główny, Kraków"/><br/><br/>

    <label>Adresy (po jednym w wierszu):</label><br/>
    <textarea id="addresses" placeholder="ul. Piękna 1, Warszawa\nul. Zielona 2, Warszawa"></textarea><br/>

    <label><input type="checkbox" id="returnToDepot" /> Powrót do depo (jeśli podano)</label><br/>

    <button id="go">Optymalizuj trasę</button>

    <h4>Wynik:</h4>
    <div id="result"></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([52.2297,21.0122], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OSM'
    }).addTo(map);

    let routeLayer;

    document.getElementById('go').addEventListener('click', async () => {
      const depot = document.getElementById('depot').value.trim() || null;
      const addresses = document.getElementById('addresses').value.split('\n').map(s => s.trim()).filter(Boolean);
      const returnToDepot = document.getElementById('returnToDepot').checked;

      if (addresses.length === 0) { alert('Dodaj przynajmniej 1 adres'); return; }

      document.getElementById('result').innerText = 'Optymalizuję...';

      try {
        const res = await fetch('/optimize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ depot, addresses, returnToDepot })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Błąd serwera');

        // wyświetl wynik
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `<b>Całkowita odległość (przybliżona):</b> ${data.totalMeters} m<br/><b>Metoda:</b> ${data.method}<br/><br/>`;
        const ol = document.createElement('ol');
        data.ordered.forEach(p => {
          const li = document.createElement('li');
          li.innerText = `${p.address} (${p.lat.toFixed(5)}, ${p.lon.toFixed(5)})${p.isDepot ? ' — depo' : ''}`;
          ol.appendChild(li);
        });
        resultDiv.appendChild(ol);

        // rysuj trasę na mapie
        if (routeLayer) map.removeLayer(routeLayer);
        const latlngs = data.ordered.map(p => [p.lat, p.lon]);
        routeLayer = L.polyline(latlngs, { weight: 4 }).addTo(map);
        // markers
        const markers = [];
        data.ordered.forEach((p, i) => {
          const m = L.marker([p.lat, p.lon]).bindPopup(`${i+1}. ${p.address}`);
          m.addTo(map);
          markers.push(m);
        });
        const group = L.featureGroup([routeLayer, ...markers]);
        map.fitBounds(group.getBounds().pad(0.2));
      } catch (err) {
        document.getElementById('result').innerText = 'Błąd: ' + err.message;
      }
    });
  </script>
</body>
</html>
